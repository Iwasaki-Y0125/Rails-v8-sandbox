# mecab-ipadic-neologdのインストール

## 目的
- mecab-ipadic-neologdのインストールすることでMeCabの分かち書きが改善するか検証するため

## 結論
- 例文（「〜のうざいから…」）では mecab-ipadic-neologd のみでは改善が不十分だった
-追加対応として、ユーザー辞書の導入し検証する必要がある。

## 変更点
- Dockerfile.dev に mecab-ipadic-neologd のインストール処理を追加
-  NEologd インストールがネットワーク要因で失敗しやすいため、最大5回までリトライ（バックオフ）を追加

## 手順
1. Dockerfile.dev に依存パッケージを追加
    NEologdインストーラが利用するコマンドをapt-get install ブロックに追記する。

    例 :
    - xz-utils
    - patch
    - file
    - （環境によって必要）sudo
    ※ `ruby:* -slim` では `sudo: command not found` が出ることがあるため、エラーになる場合のみ、sudoを追加する。

2. Dockerfile.dev にNEologd のインストール処理を追加

    ※NEologd はインストールが重く、GitHub 側の混雑などで失敗することがあるため、最大5回までリトライする。
    ```dockerfile
    # ====================
    #  NEologdのインストール
    #  NEologdは重くたまに失敗するので5回までリトライする
    # ====================
    RUN set -eux; \
    for i in 1 2 3 4 5; do \
    rm -rf /tmp/mecab-ipadic-neologd; \
    if git clone --depth 1 https://github.com/neologd/mecab-ipadic-neologd.git /tmp/mecab-ipadic-neologd && \
      /tmp/mecab-ipadic-neologd/bin/install-mecab-ipadic-neologd -n -y; then \
      rm -rf /tmp/mecab-ipadic-neologd; \
      exit 0; \
    fi; \
    echo "NEologd install failed. retry=${i}" >&2; \
    sleep $((i*10)); \
    done; \
    echo "NEologd install failed after retries" >&2; \
    exit 1
    ```

3. ビルド
    ```sh
    make dev-build-nocache
    ```
    ビルドが失敗した場合に、詳細ログ表示するコマンド
    ```bash
    DOCKER_BUILDKIT=1 docker build --progress=plain -f Dockerfile.dev .
    ```

## 動作確認
コンテナ内で以下を実行し、NEologd が使われていることを確認

```sh
mecab-config --dicdir
ls "$(mecab-config --dicdir)"
mecab -d "$(mecab-config --dicdir)/mecab-ipadic-neologd" -D | head -n 5

# 出力結果
$ mecab-config --dicdir
/usr/lib/x86_64-linux-gnu/mecab/dic

$ ls "$(mecab-config --dicdir)"
mecab-ipadic-neologd

$ mecab -d "$(mecab-config --dicdir)/mecab-ipadic-neologd" -D | head -n 5
filename:       /usr/lib/x86_64-linux-gnu/mecab/dic/mecab-ipadic-neologd/sys.dic
version:        102
charset:        UTF8
type:   0
size:   4668394
```

### 導入補足情報
- `sudo: command not found`<br>
  slim系イメージでは sudo が入っていないため、NEologd インストーラが sudo を呼ぶと失敗する。必要に応じて sudo を追加する。

- `Unable to access https://github.com/ (504)`<br>
GitHub 側・経路要因で失敗することがある。リトライ（バックオフ）で吸収する。

## 参考
- mecab-ipadic-neologd(GitHub):
 https://github.com/neologd/mecab-ipadic-neologd
- Manpages of manpages-ja in Debian testing : https://manpages.debian.org/testing/manpages-ja/index.html
- Docker ドキュメント日本語化プロジェクト(RUN) :https://docs.docker.jp/develop/develop-images/dockerfile_best-practices.html#run
